<!DOCTYPE html>
<!--
  Copyright (c) 2025 Stelau
  Author: Nicolas Chalanset
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA Test - mDL Reader</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
      line-height: 1.6;
    }
    h1 { color: #0f172a; }
    .status { 
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      border-left: 4px solid;
    }
    .success { background: #ecfdf5; border-color: #059669; color: #065f46; }
    .error { background: #fef2f2; border-color: #dc2626; color: #991b1b; }
    .warning { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
    .info { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }
    button {
      background: #1d4ed8;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover { background: #1e40af; }
    pre {
      background: #f8fafc;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.875rem;
    }
    .test-item {
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 6px;
      background: #f8fafc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pass { background: #ecfdf5; }
    .fail { background: #fef2f2; }
  </style>
</head>
<body>
  <h1>üß™ PWA Test Suite</h1>
  <p>This page tests the Progressive Web App setup for the ISO 18013-5 mDL Reader.</p>

  <h2>Prerequisites</h2>
  <div id="prereqs"></div>

  <h2>Service Worker</h2>
  <div id="sw-status"></div>
  <button onclick="testServiceWorker()">Test Service Worker</button>
  <button onclick="unregisterSW()">Unregister SW</button>
  <button onclick="clearCache()">Clear Cache</button>

  <h2>Manifest</h2>
  <div id="manifest-status"></div>
  <button onclick="testManifest()">Test Manifest</button>

  <h2>Installation</h2>
  <div id="install-status"></div>
  <button onclick="testInstall()">Check Install Status</button>

  <h2>Cache Inspection</h2>
  <div id="cache-status"></div>
  <button onclick="inspectCache()">Inspect Cache</button>

  <h2>Console Output</h2>
  <pre id="console"></pre>

  <script>
    const consoleEl = document.getElementById('console');
    function log(msg) {
      consoleEl.textContent += msg + '\n';
      console.log(msg);
    }

    // Test prerequisites
    async function testPrerequisites() {
      const div = document.getElementById('prereqs');
      const tests = [
        { name: 'HTTPS', test: () => location.protocol === 'https:' || location.hostname === 'localhost' },
        { name: 'Service Worker API', test: () => 'serviceWorker' in navigator },
        { name: 'Fetch API', test: () => 'fetch' in window },
        { name: 'Cache API', test: () => 'caches' in window },
        { name: 'Promise support', test: () => 'Promise' in window }
      ];

      let html = '';
      tests.forEach(t => {
        const result = t.test();
        html += `<div class="test-item ${result ? 'pass' : 'fail'}">
          <span>${t.name}</span>
          <span>${result ? '‚úÖ' : '‚ùå'}</span>
        </div>`;
      });
      div.innerHTML = html;
    }

    // Test Service Worker
    async function testServiceWorker() {
      const div = document.getElementById('sw-status');
      log('Testing Service Worker...');

      if (!('serviceWorker' in navigator)) {
        div.innerHTML = '<div class="status error">Service Worker API not supported</div>';
        return;
      }

      try {
        const registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          div.innerHTML = '<div class="status warning">No Service Worker registered yet. Visit index.html first.</div>';
          log('No Service Worker found');
          return;
        }

        const state = registration.active ? registration.active.state : 'none';
        const scope = registration.scope;
        
        div.innerHTML = `
          <div class="status success">
            <strong>Service Worker Active!</strong><br>
            State: ${state}<br>
            Scope: ${scope}<br>
            Script: ${registration.active ? registration.active.scriptURL : 'N/A'}
          </div>
        `;
        log(`‚úÖ Service Worker: ${state}`);
        log(`   Scope: ${scope}`);
      } catch (error) {
        div.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
        log(`‚ùå Error: ${error.message}`);
      }
    }

    // Unregister Service Worker
    async function unregisterSW() {
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        if (registration) {
          await registration.unregister();
          log('‚úÖ Service Worker unregistered');
          alert('Service Worker unregistered. Reload the page.');
        } else {
          log('‚ö†Ô∏è No Service Worker to unregister');
        }
      } catch (error) {
        log(`‚ùå Error unregistering: ${error.message}`);
      }
    }

    // Clear cache
    async function clearCache() {
      try {
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));
        log(`‚úÖ Cleared ${cacheNames.length} cache(s): ${cacheNames.join(', ')}`);
        alert(`Cleared ${cacheNames.length} cache(s)`);
      } catch (error) {
        log(`‚ùå Error clearing cache: ${error.message}`);
      }
    }

    // Test Manifest
    async function testManifest() {
      const div = document.getElementById('manifest-status');
      log('Testing manifest...');

      try {
        const response = await fetch('/manifest.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const manifest = await response.json();
        
        div.innerHTML = `
          <div class="status success">
            <strong>Manifest Loaded!</strong><br>
            Name: ${manifest.name}<br>
            Short Name: ${manifest.short_name}<br>
            Display: ${manifest.display}<br>
            Theme Color: ${manifest.theme_color}<br>
            Icons: ${manifest.icons.length}<br>
            Start URL: ${manifest.start_url}
          </div>
        `;
        log('‚úÖ Manifest OK');
        log(`   ${JSON.stringify(manifest, null, 2)}`);
      } catch (error) {
        div.innerHTML = `<div class="status error">Error loading manifest: ${error.message}</div>`;
        log(`‚ùå Manifest error: ${error.message}`);
      }
    }

    // Test installation status
    async function testInstall() {
      const div = document.getElementById('install-status');
      log('Checking install status...');

      const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                        || window.navigator.standalone === true
                        || document.referrer.includes('android-app://');

      if (isStandalone) {
        div.innerHTML = '<div class="status success">‚úÖ App is installed and running in standalone mode!</div>';
        log('‚úÖ Running as installed PWA');
      } else {
        div.innerHTML = `
          <div class="status info">
            <strong>App is not installed</strong><br>
            Display mode: ${window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser'}<br>
            <br>
            To install: Visit index.html and look for the install prompt.
          </div>
        `;
        log('‚ö†Ô∏è Not running as PWA');
      }
    }

    // Inspect cache
    async function inspectCache() {
      const div = document.getElementById('cache-status');
      log('Inspecting cache...');

      try {
        const cacheNames = await caches.keys();
        
        if (cacheNames.length === 0) {
          div.innerHTML = '<div class="status warning">No caches found</div>';
          log('‚ö†Ô∏è No caches');
          return;
        }

        let html = `<div class="status info"><strong>${cacheNames.length} cache(s) found:</strong><br><br>`;
        
        for (const name of cacheNames) {
          const cache = await caches.open(name);
          const keys = await cache.keys();
          html += `<strong>${name}</strong> (${keys.length} items)<br>`;
          log(`Cache "${name}": ${keys.length} items`);
          
          keys.forEach(req => {
            html += `  ‚Ä¢ ${req.url.replace(location.origin, '')}<br>`;
            log(`  - ${req.url}`);
          });
          html += '<br>';
        }
        
        html += '</div>';
        div.innerHTML = html;
      } catch (error) {
        div.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
        log(`‚ùå Cache error: ${error.message}`);
      }
    }

    // Run initial tests
    window.addEventListener('load', () => {
      log('=== PWA Test Suite Started ===');
      testPrerequisites();
      testServiceWorker();
      testManifest();
      testInstall();
    });
  </script>
</body>
</html>
