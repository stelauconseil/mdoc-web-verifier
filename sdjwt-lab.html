<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SD-JWT Lab (Experimental)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; margin: 0; background: #f5f7fb; color: #0f172a; }
    main { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
    .card { background: white; border-radius: 12px; padding: 1rem 1.25rem; border: 1px solid rgba(15,23,42,0.08); box-shadow: 0 8px 24px -16px rgba(15,23,42,0.12); margin-bottom: 1rem; }
    h1 { margin: 0 0 0.5rem; font-size: 1.3rem; }
    label { display:block; font-weight:600; margin: 0.6rem 0 0.3rem; }
    textarea, input[type="text"] { width: 100%; padding: 0.6rem 0.7rem; border-radius: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-family: monospace; font-size: 0.9rem; }
    .row { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; }
    button { padding: 0.55rem 0.9rem; border-radius: 8px; border: 1px solid rgba(15,23,42,0.08); background: #1d4ed8; color: white; font-weight: 600; cursor: pointer; }
    pre { background:#0f172a; color:#e2e8f0; padding: 0.75rem; border-radius: 8px; overflow:auto; }
    .muted { color:#475569; font-size:0.9rem; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/cbor-web@9.0.2/dist/cbor.min.js"></script>
  <script src="js/sdjwt-experiment.js"></script>
  <script src="js/sdjwt-response.js"></script>
</head>
<body>
  <main>
    <div class="card">
      <h1>SD-JWT Extended Request Builder (Experimental)</h1>
      <div class="muted">Draft helpers to assemble an ISO 18013-5 extended request that includes SD-JWT selection (VCTs + claim paths)</div>
      <label for="vcts">VCTs (one per line)</label>
      <textarea id="vcts" rows="4" placeholder="eu.europa.ec.eudiw.pid.1
org.iso.18013.5.mDL"></textarea>

      <label for="claims">Claim selections (one per line)
        <span class="muted">Use "." as path separator, or write arrays like age_over_or_equals.18</span>
      </label>
      <textarea id="claims" rows="4" placeholder="age_over_or_equals.18
address.street_address"></textarea>

      <div class="row" style="margin-top:0.5rem">
        <label style="display:flex;align-items:center;gap:6px; font-weight: 500;">
          <input id="retain" type="checkbox"> intent_to_retain
        </label>
        <button id="btnBuild">Build Extended Request</button>
      </div>

      <div id="outJson" style="margin-top:0.75rem"></div>
      <div id="outCbor" style="margin-top:0.75rem"></div>
    </div>

    <div class="card">
      <h1>SD-JWT DeviceResponse Inspector</h1>
      <div class="muted">Paste a decoded DeviceResponse JSON below (object with optional sdjwtDocuments: [tstr])</div>
      <textarea id="resp" rows="6" placeholder='{"version":"1.0","sdjwtDocuments":["eyJhbGciOi...","eyJhbGciOi..."]}'></textarea>
      <div class="row" style="margin-top:0.5rem">
        <button id="btnExtract">Extract SD-JWTs</button>
      </div>
      <div id="outResp" style="margin-top:0.75rem"></div>
    </div>
  </main>

<script>
  const vctsEl = document.getElementById('vcts');
  const claimsEl = document.getElementById('claims');
  const retainEl = document.getElementById('retain');
  const outJson = document.getElementById('outJson');
  const outCbor = document.getElementById('outCbor');

  const respEl = document.getElementById('resp');
  const outResp = document.getElementById('outResp');

  document.getElementById('btnBuild').addEventListener('click', () => {
    try {
      const vcts = (vctsEl.value || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const claims = (claimsEl.value || '').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const intent = !!retainEl.checked;

      const ext = SDJWT.buildExtendedItemsRequest({ vcts, claimSelections: claims, intentToRetain: intent });
      const req = SDJWT.mergeIntoDeviceRequest(SDJWT.buildSampleDeviceRequest({ vcts, claimSelections: claims, intentToRetain: intent }), ext);

      outJson.innerHTML = '<label>JSON (preview)</label><pre>'+escapeHtml(JSON.stringify(req, null, 2))+'</pre>';

      try {
        const cbor = SDJWT.toCBOR(req);
        const hex = [...new Uint8Array(cbor)].map(b=>b.toString(16).padStart(2,'0')).join(' ');
        outCbor.innerHTML = '<label>CBOR (hex preview)</label><pre>'+hex+'</pre>';
      } catch (e) {
        outCbor.innerHTML = '<div class="muted">CBOR encode unavailable: '+(e.message||e)+'</div>';
      }
    } catch(e) {
      outJson.innerHTML = '<div class="muted">Error: '+(e.message||e)+'</div>';
      outCbor.innerHTML = '';
    }
  });

  document.getElementById('btnExtract').addEventListener('click', () => {
    try {
      const obj = JSON.parse(respEl.value || '{}');
      const list = SDJWTResponse.extractFromDeviceResponse(obj);
      if (!list.length) { outResp.innerHTML = '<div class="muted">No sdjwtDocuments found</div>'; return; }
      let html = '<label>Extracted SD-JWTs</label>';
      list.forEach(item => {
        html += '<div class="card" style="margin:0.5rem 0; padding:0.75rem">'+
          '<div><strong>Index:</strong> '+item.index+'</div>'+
          '<div><strong>Length:</strong> '+item.preview.length+'</div>'+
          '<div><strong>Header:</strong> <pre>'+escapeHtml(JSON.stringify(item.preview.header, null, 2))+'</pre></div>'+
          '<div><strong>Compact:</strong> <pre>'+escapeHtml(item.token)+'</pre></div>'+
          '</div>';
      });
      outResp.innerHTML = html;
    } catch (e) {
      outResp.innerHTML = '<div class="muted">Parse error: '+(e.message||e)+'</div>';
    }
  });

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }
</script>
</body>
</html>
